---
layout: post
title: "asp mvc jquery from cdn with fallback to localhost"
date: 2011-03-15
comments: false
categories:
 - mvc
 - jquery
---

<div class='post'>
Paul Irish has some nice code for loading jquery from cdn but then falling back to localhost if it cannot be loaded from cdn. Check it out <a href="http://paulirish.com/2010/the-protocol-relative-url/">here</a>.<br /><br />For asp mvc you usually also want jquery.valdiater and possibly unobtrusive validation as well. Here is an html helper to generate html mark up that handles loading these via cdn with fallback<br /><br />The helper<br /><script src="https://gist.github.com/871851.js?file=cdn-with-fallback.cs"></script><br /><noscript><br />using System;<br />using System.Web.Mvc;<br />using System.Web.Mvc.Html;<br />using System.Web.Routing;<br /><br />public static class HtmlHelperExtensions<br />{<br />    /// <summary><br />    /// render script tag to include javascript file from cdn, but fallback to local if cannot be loaded<br />    /// </summary><br />    /// <param name="helper"></param>    /// <param name="cdnPath">start with // to handle either http or https</param>    /// <param name="localPath">start with ~/</param>    /// <param name="javascriptCondition">javascript condition, if true then your browser will load the local file</param>    /// <returns><br />    ///    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script><br />    ///    <script>!window.jQuery && document.write(unescape('%3Cscript src="/Scripts/jquery-1.4.4.min.js"%3E%3C/script%3E'))</script><br />    /// </returns><br />    /// <seealso cref="http://paulirish.com/2010/the-protocol-relative-url/"/><br />    public static MvcHtmlString JavascriptIncludeFromCdnWithFallback(this HtmlHelper helper, string cdnPath, string localPath, string javascriptCondition)<br />    {<br />        var urlHelper = new UrlHelper(helper.ViewContext.RequestContext);<br />        var cdnBuilder = new TagBuilder("script");<br />        var localBuilder = new TagBuilder("script");<br /><br />        // src for cdn resource<br />        cdnBuilder.Attributes.Add("src", cdnPath);<br />        // js to build a local script tag if needed<br />        localBuilder.InnerHtml = String.Format<br />        (<br />            "{0} && document.write(unescape('%3Cscript src=\"{1}\"%3E%3C/script%3E'))",<br />            javascriptCondition,<br />            urlHelper.Content(localPath)<br />        );<br />        // return markup<br />        var built = String.Format("{0}\n\t{1}", cdnBuilder.ToString(TagRenderMode.Normal), localBuilder.ToString(TagRenderMode.Normal));<br />        return MvcHtmlString.Create(built);<br />    }<br />}<br /></noscript><br /><br />Usage, most likely from your layout file<br /><script src="https://gist.github.com/871856.js?file=cdn-with-fallback.cshtml"></script><br /><noscript><br />@Html.JavascriptIncludeFromCdnWithFallback(<br />    "//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js",<br />    "~/Scripts/lib/jquery/jquery-1.4.4.min.js", <br />    "!window.jQuery"<br />)<br /><br />@Html.JavascriptIncludeFromCdnWithFallback(<br />    "//ajax.aspnetcdn.com/ajax/jquery.validate/1.7/jquery.validate.min.js",<br />    "~/Scripts/lib/jquery/jquery.validate.min.js", <br />    "!window.jQuery.validator"<br />)<br /><br />@Html.JavascriptIncludeFromCdnWithFallback(<br />    "//ajax.aspnetcdn.com/ajax/mvc/3.0/jquery.validate.unobtrusive.min.js",<br />    "~/Scripts/lib/jquery/jquery.validate.unobtrusive.min.js", <br />    "!window.jQuery.validator.unobtrusive"<br />)<br /></noscript><br /><br />And the rendered html<br /><script src="https://gist.github.com/871857.js?file=cdn-with-fallback-rendered.html"></script><br /><noscript><br /><script src="//ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script><br /><script>!window.jQuery && document.write(unescape('%3Cscript src="/Scripts/lib/jquery/jquery-1.4.4.min.js"%3E%3C/script%3E'))</script><br /><br /><script src="//ajax.aspnetcdn.com/ajax/jquery.validate/1.7/jquery.validate.min.js"></script><br /><script>!window.jQuery.validator && document.write(unescape('%3Cscript src="/Scripts/lib/jquery/jquery.validate.min.js"%3E%3C/script%3E'))</script><br /><br /><script src="//ajax.aspnetcdn.com/ajax/mvc/3.0/jquery.validate.unobtrusive.min.js"></script><br /><script>!window.jQuery.validator.unobtrusive && document.write(unescape('%3Cscript src="/Scripts/lib/jquery/jquery.validate.unobtrusive.min.js"%3E%3C/script%3E'))</script><br /></noscript></div>
