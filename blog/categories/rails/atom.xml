<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: rails | house9]]></title>
  <link href="http://jessehouse.com/blog/categories/rails/atom.xml" rel="self"/>
  <link href="http://jessehouse.com/"/>
  <updated>2014-02-13T14:34:46-08:00</updated>
  <id>http://jessehouse.com/</id>
  <author>
    <name><![CDATA[Jesse House]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails: Timezones]]></title>
    <link href="http://jessehouse.com/blog/2013/11/15/working-with-timezones-and-ruby-on-rails/"/>
    <updated>2013-11-15T10:03:00-08:00</updated>
    <id>http://jessehouse.com/blog/2013/11/15/working-with-timezones-and-ruby-on-rails</id>
    <content type="html"><![CDATA[<p>This article outlines some basic guidelines to follow when working with timezones in Ruby on Rails applications. Ruby on Rails has great support for timezones, but getting it working correctly can be tricky. Following the techniques below should save you some headache.</p>

<ul>
<li>Application Settings &ndash; use the default UTC settings</li>
<li>Set each request to the logged on users timezone</li>
<li>Display times and dates using the I18n view helpers</li>
<li>Override user timezone when displaying time aware entity</li>
<li>Override user timezone when saving time aware entity</li>
<li>Filter data based on the users timezone</li>
</ul>


<blockquote><p>Is it &lsquo;time zone&rsquo;, &lsquo;timezone&rsquo; or &lsquo;time-zone&rsquo;? Both styles end up being used in rails code base <code>config.time_zone</code> and <code>config.active_record.default_timezone</code>. I use timezone in this article and time_zone in the sample code base. Read more on <a href="http://english.stackexchange.com/questions/3934/time-zone-vs-timezone">stackexchange</a>.</p></blockquote>

<p>Sample code can be found at: <a href="https://github.com/house9/sample_timez">https://github.com/house9/sample_timez</a></p>

<p>The sample includes user profiles with timezone settings, an event model, and a work schedule model. It comes with a small set of sample data as well. To set it up locally, follow the <a href="https://github.com/house9/sample_timez/blob/master/README.md">README</a> instructions.</p>

<h2>Application Settings</h2>

<p>Rails uses the following defaults for a new application</p>

<ul>
<li>Application assumes it is running in UTC</li>
<li>Database assumes it is storing data in UTC</li>
</ul>


<blockquote><p>I recommend you keep these defaults!</p></blockquote>

<h4>in rails console (default settings)</h4>

<p>```ruby
Time.zone.name</p>

<h1>=> &ldquo;UTC&rdquo;</h1>

<p>ActiveRecord::Base.default_timezone</p>

<h1>=> :utc</h1>

<p>```</p>

<p>Both <em>can be</em> overriden in your application configuration file (config/application.rb) &ndash; <em>don&rsquo;t do it!</em></p>

<p>```ruby</p>

<h1>Do NOT do this!!!</h1>

<p>config.time_zone = &lsquo;Central Time (US &amp; Canada)&rsquo;
config.active_record.default_timezone = :local
```</p>

<h2>Set the timezone for each request</h2>

<p>How you determine the &lsquo;current users&rsquo; timezone will differ from application to application. In the sample code we are storing the value on the user model in a time_zone field. The sample application uses the techniques from this <a href="http://railscasts.com/episodes/106-time-zones-revised">RailsCast</a> episode. Alternatively you may  want to set it based on the client&rsquo;s browser setting.</p>

<p>Use an <code>around_filter</code> or combo of <code>before_filter</code> and <code>after_filter</code> to set each request&rsquo;s timezone in the <code>ApplicationController</code>. If we don&rsquo;t have a current user it will default to UTC.</p>

<p>```ruby
class ApplicationController &lt; ActionController::Base
  # &hellip;
  around_filter :user_time_zone, if: :current_user</p>

<p>  private</p>

<p>  def user_time_zone(&amp;block)</p>

<pre><code>Time.use_zone(current_user.time_zone, &amp;block)
</code></pre>

<p>  end
end
```</p>

<h2>Display times and dates using the I18n view helpers</h2>

<p>The <code>I18n</code> helpers are timezone aware. Aside from rendering the datetimes in the logged on users locale format, they will convert the stored UTC times to the current threads timezone.</p>

<ul>
<li><a href="http://guides.rubyonrails.org/i18n.html#adding-date-time-formats">http://guides.rubyonrails.org/i18n.html#adding-date-time-formats</a></li>
<li><a href="https://github.com/svenfuchs/rails-i18n/tree/master/rails/locale">https://github.com/svenfuchs/rails-i18n/tree/master/rails/locale</a></li>
</ul>


<p>On the homepage of the sample application there are numerous examples, also check out the <code>config/locales/en.yml</code> file.</p>

<p>Basic example:</p>

<p><code>ruby
I18n.localize(current_user.created_at)
</code></p>

<blockquote><p>Beware: I18n.localize does not handle nil values. You will need to guard against nils for nullable columns.</p></blockquote>

<h2>Override the display of dates</h2>

<p>In the sample application we have an Event model and a WorkSchedule model. Each model has its own timezone. Events are based on where the event will actually occur. In this case displaying the dates in the users timezone makes no sense at all, so we must override the display. There are a few techniques that can be employed:</p>

<ul>
<li><a href="http://api.rubyonrails.org/classes/DateTime.html#method-i-in_time_zone">in_time_zone</a> method (see work schedule in the sample application)</li>
<li><a href="http://api.rubyonrails.org/classes/Time.html#method-c-use_zone">Time.use_zone</a> blocks (see events in the sample application)</li>
</ul>


<p><code>in_time_zone</code> example: WorkSchedule overrides the start_at and end_at model attributes, therefore no special handling is needed in the views (of course you still need to use I18n.localize).</p>

<p>```ruby
class WorkSchedule &lt; ActiveRecord::Base
  def start_at</p>

<pre><code>super.in_time_zone(time_zone) if super &amp;&amp; time_zone
</code></pre>

<p>  end</p>

<p>  def end_at</p>

<pre><code>super.in_time_zone(time_zone) if super &amp;&amp; time_zone
</code></pre>

<p>  end
end
```</p>

<p><code>Time.use_zone</code> example: The Event model does <em>not</em> override start_at or end_at attributes, but uses Time.use_zone blocks in the views.</p>

<pre><code>&lt;!-- displayed times in the events timezone --&gt;
&lt;% Time.use_zone(@event.time_zone) do %&gt;
  &lt;%= l(@event.start_at) %&gt;
  &lt;%= l(@event.end_at) %&gt;
&lt;% end %&gt;
&lt;!-- now back to the logged on users timezone --&gt;
&lt;p&gt;
  Created at &lt;%= l(@event.created_at) %&gt;
  Updated at &lt;%= l(@event.updated_at) %&gt;
&lt;/p&gt;
</code></pre>

<p>There is odd behavior with Time.use_zone when doing in-memory sorting in ruby (<code>sort_by</code>). See the <code>HomeController</code> in the sample application. Ordered attributes do not convert in the use_zone block. I am not sure if this a bug or by design.</p>

<h2>Override timezone when saving data</h2>

<p>Sometimes you want to override saving data. Let&rsquo;s say my profile is set up with &lsquo;Pacific&rsquo; timezone, but I am creating an event that will occur in New York (&lsquo;Eastern&rsquo; timezone). I do <em>not</em> want rails to convert the times to &lsquo;Pacific&rsquo;. We can reset the current threads timezone to the events timezone before the create and update actions execute.</p>

<p>```ruby
class EventsController &lt; ApplicationController
  before_action :set_event_time_zone, only: [:create, :update]</p>

<p>  # &hellip; all action code (unchanged)</p>

<p>  private</p>

<p>  def set_event_time_zone</p>

<pre><code>if params[:event]
  Time.zone = params[:event][:time_zone]
end
</code></pre>

<p>  end
end
```</p>

<p>Alternatively this could be done using <code>Time.use_zone</code> blocks in the create and update actions.</p>

<h2>Filter data based on the users timezone</h2>

<p>Rails will handle most of this automatically if you don&rsquo;t use raw sql. For example:</p>

<p><code>ruby
articles = Article.where("published_at &gt; ?", Time.zone.now)
</code></p>

<p>If you are filtering datetime data by the day be careful, the below queries are from the sample application logged in as a user with <code>(GMT+06:00) Astana</code> timezone</p>

<p>```ruby</p>

<h1>WARNING: do not do this</h1>

<h1>events created yesterday</h1>

<p>yesterday = Date.current &ndash; 1.day
Event.where(&ldquo;DATE(created_at) = ?&rdquo;, yesterday)</p>

<h1>=> SELECT &ldquo;events&rdquo;.* FROM &ldquo;events&rdquo; WHERE (DATE(created_at) = &lsquo;2013-11-14&rsquo;)</h1>

<h1>=> 0 records</h1>

<p>```</p>

<p>the proper way</p>

<p>```ruby</p>

<h1>events created yesterday</h1>

<p>start_at = (Date.current &ndash; 1.day).beginning_of_day
end_at = start_at.end_of_day
@events_from_yesterday = Event.where(&ldquo;created_at BETWEEN ? AND ?&rdquo;, start_at, end_at)</p>

<h1>=> SELECT &ldquo;events&rdquo;.* FROM &ldquo;events&rdquo; WHERE (created_at BETWEEN &lsquo;2013-11-13 18:00:00&rsquo; AND &lsquo;2013-11-14 17:59:59&rsquo;)</h1>

<h1>=> 12 records</h1>

<p>```</p>

<blockquote><p>This is not an issue when filtering on date columns (only datetime).</p></blockquote>

<p>```ruby</p>

<h1>rails will do it for us, Date.current is timezone aware</h1>

<p>Meeting.where(&ldquo;scheduled_on = ?&rdquo;, Date.current)</p>

<h1>but do NOT do this, will not work correctly at certain times of the day</h1>

<p>Meeting.where(&ldquo;scheduled_on = ?&rdquo;, Date.today)
```</p>

<p>In some situations you might need to query for data based on a specific timezone</p>

<p>```ruby
@corp_office = OpenStruct.new({ time_zone: &ldquo;Eastern Time (US &amp; Canada)&rdquo; })</p>

<p>Time.use_zone(@corp_office.time_zone) do
  start_at = Date.current.beginning_of_day
  end_at = start_at.end_of_day
  @events_scheduled_today = Event.where(&ldquo;start_at BETWEEN ? AND ?&rdquo;, start_at, end_at).order(:start_at)
end</p>

<h1>=> SELECT &ldquo;events&rdquo;.* FROM &ldquo;events&rdquo; WHERE (start_at BETWEEN &lsquo;2013-11-13 05:00:00&rsquo; AND &lsquo;2013-11-14 04:59:59&rsquo;) ORDER BY &ldquo;events&rdquo;.&ldquo;start_at&rdquo; ASC</h1>

<p>```</p>

<h2>Conclusion</h2>

<p>I hope you found this article helpful. All feedback is welcome &ndash; I am sure I have left out some key information or just plain got it wrong.</p>

<p>Additional Reading: <a href="http://www.elabs.se/blog/36-working-with-time-zones-in-ruby-on-rails">http://www.elabs.se/blog/36-working-with-time-zones-in-ruby-on-rails</a></p>

<h2>ETC&hellip; (links and resources)</h2>

<p><code>
rake time:zones:all
</code></p>

<p><code>
ActiveSupport::TimeZone.zones_map
ActiveSupport::TimeZone.us_zones
</code></p>

<ul>
<li>API: <a href="http://api.rubyonrails.org/classes/DateTime.html">DateTime</a></li>
<li>API: <a href="http://api.rubyonrails.org/classes/ActionView/Helpers/FormOptionsHelper.html#method-i-time_zone_select">time_zone_select</a></li>
<li>Stackoverflow: <a href="http://stackoverflow.com/questions/19664652/timezone-confusion-in-ruby-on-rails-4-0-postgres">Timezone confusion</a></li>
<li>Stackoverflow: <a href="http://stackoverflow.com/questions/17818329/rails-3-timezone-confusions/17840938#17840938">More timezone confusion</a></li>
<li>Postgresql: <a href="http://www.postgresql.org/docs/9.3/static/functions-datetime.html#FUNCTIONS-DATETIME-ZONECONVERT">AT TIME ZONE</a></li>
<li><a href="https://github.com/rails/rails/issues/9610">datetime_select preselects wrong times upon edit</a></li>
</ul>


<p>```
Good naming conventions for date and datetime (your milage may vary)</p>

<p>datetime: should end in _at (created_at, updated_at, start_at, end_at)</p>

<pre><code>date: should end in _on (start_on, end_on, work_on)
</code></pre>

<p>```</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Ruby on Rails continuous integration (CI) with Jenkins the easy way with Chef and Knife]]></title>
    <link href="http://jessehouse.com/blog/2013/02/23/ruby-on-rails-continuous-integration-ci/"/>
    <updated>2013-02-23T00:00:00-08:00</updated>
    <id>http://jessehouse.com/blog/2013/02/23/ruby-on-rails-continuous-integration-ci</id>
    <content type="html"><![CDATA[<div class='post'>
Do you need a CI build setup for your Ruby on Rails app?<br /><br />Here are some <a href="http://www.opscode.com/chef/">chef</a> / <a href="http://matschaffer.github.com/knife-solo/">knife solo</a> scripts that will deploy a <a href="http://jenkins-ci.org/">Jenkins</a> server to run your <a href="http://www.martinfowler.com/articles/continuousIntegration.html">CI build</a> - you could be up and running in less than 1/2 an hour<br /><br /><a href="https://github.com/house9/ci_chef_jenkins_rails"><b>https://github.com/house9/ci_chef_jenkins_rails</b></a><br /><br />Check out the README for details<br /><br /><br /></div>


<h2>Comments</h2>


<div class='comments'>
<div class='comment'>
<div class='author'>patcon</div>
<div class='content'>
You might want to look into Pivotal Labs&#39; ciborg project -- sounds like it&#39;s just what you&#39;re looking for :)<br /><br />https://github.com/pivotal/ciborg</div>
</div>
</div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sending email with Rails Mailers, The Random bits...]]></title>
    <link href="http://jessehouse.com/blog/2012/12/16/sending-email-with-rails-mailers-random/"/>
    <updated>2012-12-16T00:00:00-08:00</updated>
    <id>http://jessehouse.com/blog/2012/12/16/sending-email-with-rails-mailers-random</id>
    <content type="html"><![CDATA[<div class='post'>
<i>See the rails guides and railscasts for getting started with Rails Mailers;&nbsp;</i><br /><i>this article includes some additional information on Rails Mailers not included in those articles.</i><br /><br /><b>RailsCasts: </b><a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">http://railscasts.com/episodes/206-action-mailer-in-rails-3</a><br /><b>Rails Guides: </b>"<a href="http://guides.rubyonrails.org/action_mailer_basics.html">Action Mailer Basics</a>" on the rails guides -&nbsp;The guide covers all of the common mailer tasks<br /><ul><li>setup and configuration</li><li>attachments</li><li>layouts</li></ul><br /><span style="font-size: x-large;">Random Bits</span><br /><blockquote class="tr_bq"><i>These examples were created using rails 3.2</i></blockquote><div><div><span style="font-size: large;">Add importance headers</span></div><div><br /></div><div><script src="https://gist.github.com/4308619.js"></script></div><blockquote class="tr_bq"><i>NOTE: many email clients will ignore these headers</i></blockquote></div><div><br /></div><div><div><span style="font-size: large;">Add receipt header</span></div><div><br /></div><div><script src="https://gist.github.com/4308683.js"></script></div><blockquote class="tr_bq"><i>NOTE: many email clients will ignore these headers</i></blockquote></div><div><div><span style="font-size: large;"><br /></span><span style="font-size: large;">Testing mailer headers with rspec</span></div><div><br /></div><div>If you have <a href="https://github.com/rspec/rspec-rails">rspec-rails gem</a> installed with your rails application then&nbsp;running the generator will stub out most of your mailer tests, including a fixture file for the mailer view, which you may or may not want to remove.</div><div><br /></div><div><script src="https://gist.github.com/4308712.js"></script></div><blockquote class="tr_bq"><i>NOTE: test against mail.header, not mail.headers</i></blockquote></div><div><div><span style="font-size: large;"><br /></span><span style="font-size: large;">Use a different layout for some Mailer actions</span></div><div><br /></div><div>our default layout is the customer facing one&nbsp;but we want to override it in some cases</div><div><br /></div><div><script src="https://gist.github.com/4309219.js"></script></div></div><div><br /></div><div><br /></div><br /></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Setting up a C.I. build (Continuous Integration) for a Ruby on Rails application]]></title>
    <link href="http://jessehouse.com/blog/2012/11/03/setting-up-ci-build-continuous/"/>
    <updated>2012-11-03T00:00:00-07:00</updated>
    <id>http://jessehouse.com/blog/2012/11/03/setting-up-ci-build-continuous</id>
    <content type="html"><![CDATA[<div class='post'>
<br />It has never been easier than with Semaphore - Hosted Continuous Integration<br /><br /><ul><li><a href="https://semaphoreapp.com/">https://semaphoreapp.com/</a></li></ul><br />How easy is it<br /><br /><ul><li>add semaphore ssh key to your github repo</li><li>then semaphore automatically determines your ruby version, database, etc...</li><li>you can tweak the build steps later, the defaults are pretty good</li></ul><br />It will automatically detect new branches!!! That means zero setup when the new branch is added<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-HqVYteyXvQk/UJVdSqJnYOI/AAAAAAAAC6U/AU4oP3tZ2D8/s1600/semaphoreapp-01.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="348" src="http://4.bp.blogspot.com/-HqVYteyXvQk/UJVdSqJnYOI/AAAAAAAAC6U/AU4oP3tZ2D8/s640/semaphoreapp-01.png" width="640" /></a></div><br /><br />It is not <a href="https://semaphoreapp.com/pricing">cheap</a>, for personal side projects it might not make sense?<br />But well worth the money if you are doing paid development<br /></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sample Routes and Links with Rails 3 in the console]]></title>
    <link href="http://jessehouse.com/blog/2011/11/12/sample-routes-and-links-with-rails-3-in/"/>
    <updated>2011-11-12T00:00:00-08:00</updated>
    <id>http://jessehouse.com/blog/2011/11/12/sample-routes-and-links-with-rails-3-in</id>
    <content type="html"><![CDATA[<div class='post'>
The content for this post is all from a gist, hopefully someone finds it useful<br /><br /><script src="https://gist.github.com/1361290.js?file=routes_link_to_in_rails_console.rb"></script><br /><noscript><br />Your reader does not support script, view the gist here<br />https://gist.github.com/1361290<br /></noscript><br /><br /><b>Resources</b><br /><br /><br /><ul><li><a href="http://stackoverflow.com/questions/2778074/recognize-routes-in-rails-console-session">http://stackoverflow.com/questions/2778074/recognize-routes-in-rails-console-session</a></li></ul></div>

]]></content>
  </entry>
  
</feed>
